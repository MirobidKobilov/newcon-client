name: Auto Deploy via SSH (git pull + build)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Connect to server via SSH and deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "Connecting to $SSH_USER@$SSH_HOST:$SSH_PORT..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'EOF'
            set -euo pipefail

            APP_DIR="/home/ubuntu/newcon-client"  # adjust to your repo path
            BRANCH="main"

            echo "[deploy] entering $APP_DIR"
            cd "$APP_DIR"

            echo "[deploy] pulling latest code..."
            git fetch --all --prune
            git reset --hard "origin/${BRANCH}"

            echo "[deploy] loading nvm..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            if [ -f ".nvmrc" ]; then
              nvm install
              nvm use
            fi

            echo "[deploy] node version: $(node -v)"
            echo "[deploy] npm version: $(npm -v)"

            echo "[deploy] installing dependencies..."
            npm ci

            echo "[deploy] building vite app..."
            npm run build

            echo "[deploy] âœ… done (built into .dist)"
          EOF
