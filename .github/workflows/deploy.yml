name: Deploy Frontend (native SSH)

on:
  push:
    branches: [ "main" ]   # change if needed
  workflow_dispatch:

env:
  BRANCH: main             # deploy branch (change if needed)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Write SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_ed25519
          chmod 600 id_ed25519

      - name: Deploy on server (git pull + build to dist)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          APP_DIR:  ${{ secrets.DEPLOY_PATH }}   # e.g. /home/newcon/newcon-client
          BRANCH:   ${{ env.BRANCH }}
        run: |
          # Use -T to disable TTY (avoids "Pseudo-terminal will not be allocated" issues)
          ssh -T -i id_ed25519 -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "bash -lc '
            set -euo pipefail

            echo \"[deploy] APP_DIR: $APP_DIR\"
            cd \"$APP_DIR\"

            echo \"[deploy] fetch & reset → origin/$BRANCH\"
            git fetch --all --prune
            git reset --hard \"origin/$BRANCH\"

            # --- Optional: pin Node with nvm if your repo has .nvmrc ---
            export NVM_DIR=\$HOME/.nvm
            [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
            if [ -f \".nvmrc\" ]; then
              nvm install
              nvm use
            fi

            # Optional: respect packageManager pin (npm/yarn/pnpm) if you set it in package.json
            if command -v corepack >/dev/null 2>&1; then corepack enable || true; fi

            echo \"[deploy] install deps\"
            npm ci

            echo \"[deploy] build (Vite → dist)\"
            npm run build

            test -f \"dist/index.html\" && echo \"[deploy] ✅ build ready\" || (echo \"[deploy] ❌ dist/index.html missing\" && exit 1)
          '"
