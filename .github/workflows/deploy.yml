name: Deploy Newcon client

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (not strictly required here, but ok)
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        # Add server to known_hosts to avoid interactive prompt
        ssh-keyscan -H 144.91.98.161 >> ~/.ssh/known_hosts

    - name: Deploy via SSH (git pull + build to .dist)
      env:
        APP_DIR: /home/newcon/newcon-client   # <-- your repo path on the server
        BRANCH: main
      run: |
        ssh -i ~/.ssh/id_ed25519 root@144.91.98.161 << 'EOF'
          set -euo pipefail

          APP_DIR="/home/newcon/newcon-client"
          BRANCH="main"

          cd "$APP_DIR"

          echo "[deploy] pull latest"
          git fetch --all --prune
          git reset --hard "origin/${BRANCH}"

          # --- Node version pin via nvm (optional but recommended if you have .nvmrc) ---
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          if [ -f ".nvmrc" ]; then
            nvm install
            nvm use
          fi

          # If you pinned package manager in package.json ("packageManager": "npm@x.y.z"), enable corepack:
          if command -v corepack >/dev/null 2>&1; then corepack enable || true; fi

          echo "[deploy] install deps"
          npm ci

          echo "[deploy] build vite → .dist"
          npm run build

          # quick sanity check
          test -f ".dist/index.html" || (echo "Build missing .dist/index.html" && exit 1)

          echo "[deploy] ✅ done"
        EOF
