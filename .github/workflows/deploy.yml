name: Auto Deploy via native SSH

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Write SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_ed25519
          chmod 600 id_ed25519

      - name: Deploy on server (git pull + build)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # Use -tt to force a TTY (fixes "Pseudo-terminal..." + shells that require TTY)
          # If your server *dislikes* TTY, swap -tt for -T (disable TTY) instead.
          ssh -tt -i id_ed25519 -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            'bash -lc "
              set -euo pipefail

              APP_DIR=\"/home/ubuntu/newcon-client\"   # <- change to your server path
              BRANCH=\"main\"

              cd \"$APP_DIR\"
              echo [deploy] pulling latest...
              git fetch --all --prune
              git reset --hard origin/${BRANCH}

              # --- pin Node with nvm if you have .nvmrc ---
              export NVM_DIR=\$HOME/.nvm
              [ -s \$NVM_DIR/nvm.sh ] && . \$NVM_DIR/nvm.sh
              if [ -f .nvmrc ]; then
                nvm install
                nvm use
              fi
              node -v && npm -v

              echo [deploy] installing deps...
              npm ci

              echo [deploy] building...
              npm run build

              test -f .dist/index.html && echo [deploy] âœ… done || (echo Build missing .dist/index.html && exit 1)
            "'
